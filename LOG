============================= test session starts ==============================
platform linux -- Python 3.11.7, pytest-8.4.1, pluggy-1.6.0
rootdir: /home/deadpool/Playground/CS336/assignment1-basics
configfile: pyproject.toml
plugins: jaxtyping-0.3.2
collected 48 items / 47 deselected / 1 selected

tests/test_model.py::test_rope FAILED

=================================== FAILURES ===================================
__________________________________ test_rope ___________________________________

numpy_snapshot = <tests.conftest.NumpySnapshot object at 0x7f5f44159d50>
in_embeddings = tensor([[[-0.9414,  1.2632, -0.1838,  ..., -0.1941,  0.0048, -1.3165],
         [ 0.0204, -0.1652,  0.2109,  ...,  0.6...73, -0.5486,  ...,  1.5676, -1.1472, -1.5822],
         [ 1.5936, -0.4113,  0.6037,  ..., -0.6494,  1.2858,  0.4321]]])
d_model = 64, theta = 10000.0, n_queries = 12
pos_ids = tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11])

    def test_rope(numpy_snapshot, in_embeddings, d_model, theta, n_queries, pos_ids):
        output = run_rope(
            d_model, theta=theta, max_seq_len=n_queries, in_query_or_key=in_embeddings, token_positions=pos_ids
        )
>       numpy_snapshot.assert_match(output, atol=1e-6)

tests/test_model.py:190: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <tests.conftest.NumpySnapshot object at 0x7f5f44159d50>
actual = tensor([[[-9.4142e-01,  1.2632e+00, -1.8377e-01,  ..., -1.9406e-01,
           4.8184e-03, -1.3165e+00],
         [ 1....1.5822e+00],
         [ 7.0528e-03, -1.8203e-03, -2.3221e-01,  ..., -6.4935e-01,
           1.2858e+00,  4.3206e-01]]])
rtol = 0.0001, atol = 1e-06, test_name = 'test_rope', force_update = False

    def assert_match(
        self,
        actual: _A | dict[str, _A],
        rtol: float = 1e-4,
        atol: float = 1e-2,
        test_name: str | type[DEFAULT] = DEFAULT,
        force_update: bool | type[DEFAULT] = DEFAULT,
    ):
        """
        Assert that the actual array(s) matches the snapshot.
    
        Args:
            actual: Single NumPy array or dictionary of named arrays
            test_name: The name of the test (used for the snapshot file)
            update: If True, update the snapshot instead of comparing
        """
        if force_update is DEFAULT:
            force_update = self.default_force_update
        if self.always_match_exact:
            rtol = atol = 0
        if test_name is DEFAULT:
            assert self.default_test_name is not None, "Test name must be provided or set as default"
            test_name = self.default_test_name
    
        snapshot_path = self._get_snapshot_path(test_name)
    
        # Convert single array to dictionary for consistent handling
        arrays_dict = actual if isinstance(actual, dict) else {"array": actual}
        arrays_dict = {k: _canonicalize_array(v) for k, v in arrays_dict.items()}
    
        # Load the snapshot
        expected_arrays = dict(np.load(snapshot_path))
    
        # Verify all expected arrays are present
        missing_keys = set(arrays_dict.keys()) - set(expected_arrays.keys())
        if missing_keys:
            raise AssertionError(f"Keys {missing_keys} not found in snapshot for {test_name}")
    
        # Verify all actual arrays are expected
        extra_keys = set(expected_arrays.keys()) - set(arrays_dict.keys())
        if extra_keys:
            raise AssertionError(f"Snapshot contains extra keys {extra_keys} for {test_name}")
    
        # Compare all arrays
        for key in arrays_dict:
>           np.testing.assert_allclose(
                _canonicalize_array(arrays_dict[key]),
                expected_arrays[key],
                rtol=rtol,
                atol=atol,
                err_msg=f"Array '{key}' does not match snapshot for {test_name}",
            )
E           AssertionError: 
E           Not equal to tolerance rtol=0.0001, atol=1e-06
E           Array 'array' does not match snapshot for test_rope
E           Mismatched elements: 2769 / 3072 (90.1%)
E           Max absolute difference among violations: 3.5049047
E           Max relative difference among violations: 404.34695
E            ACTUAL: array([[[-9.414165e-01,  1.263247e+00, -1.837694e-01, ...,
E                    -1.940586e-01,  4.818352e-03, -1.316472e+00],
E                   [ 1.102281e-02, -8.925372e-02,  1.543487e-01, ...,...
E            DESIRED: array([[[-0.941417,  1.263247, -0.183769, ..., -0.194059,  0.004818,
E                    -1.316472],
E                   [ 0.150027, -0.072087, -0.197822, ...,  0.671586,  0.312369,...

tests/conftest.py:89: AssertionError
=========================== short test summary info ============================
FAILED tests/test_model.py::test_rope - AssertionError: 
======================= 1 failed, 47 deselected in 0.80s =======================
